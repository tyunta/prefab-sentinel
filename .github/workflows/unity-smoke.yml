name: unity-smoke

on:
  workflow_dispatch:
    inputs:
      unity_command:
        description: "Path to Unity.exe used for batchmode."
        required: true
        type: string
      targets:
        description: "Smoke target selection."
        required: true
        default: all
        type: choice
        options:
          - all
          - avatar
          - world
      unity_execute_method:
        description: "Unity executeMethod entrypoint."
        required: false
        default: "PrefabSentinel.UnityPatchBridge.ApplyFromJson"
        type: string
      unity_timeout_sec:
        description: "Batchmode timeout (seconds)."
        required: false
        default: "600"
        type: string
      avatar_unity_timeout_sec:
        description: "Avatar target-specific timeout (seconds). Optional."
        required: false
        default: ""
        type: string
      world_unity_timeout_sec:
        description: "World target-specific timeout (seconds). Optional."
        required: false
        default: ""
        type: string
      timeout_profile_path:
        description: "Optional timeout profile JSON path (smoke-history output)."
        required: false
        default: ""
        type: string
      expect_applied_from_plan:
        description: "Infer expected applied count from each target plan ops length."
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"
      max_applied_mismatches:
        description: "Optional smoke-history gate: maximum allowed applied assertion mismatches."
        required: false
        default: ""
        type: string
      min_applied_pass_pct:
        description: "Optional smoke-history gate: minimum required applied assertion pass percentage."
        required: false
        default: ""
        type: string
      avatar_plan:
        description: "Avatar patch plan path."
        required: false
        default: "sample/avatar/config/prefab_patch_plan.json"
        type: string
      world_plan:
        description: "World patch plan path."
        required: false
        default: "sample/world/config/prefab_patch_plan.json"
        type: string
      avatar_project_path:
        description: "Avatar Unity project root."
        required: false
        default: "sample/avatar"
        type: string
      world_project_path:
        description: "World Unity project root."
        required: false
        default: "sample/world"
        type: string
      run_window_start_utc_hour:
        description: "Optional UTC run window start hour (0-23)."
        required: false
        default: ""
        type: string
      run_window_end_utc_hour:
        description: "Optional UTC run window end hour (0-23)."
        required: false
        default: ""
        type: string

jobs:
  bridge-smoke-unity:
    runs-on:
      - self-hosted
      - windows
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Package
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .

      - name: Preflight Input Paths
        shell: pwsh
        run: |
          $target = "${{ inputs.targets }}"
          $windowStartRaw = "${{ inputs.run_window_start_utc_hour }}"
          $windowEndRaw = "${{ inputs.run_window_end_utc_hour }}"
          if ($target -eq "all" -or $target -eq "avatar") {
            if (-not (Test-Path "${{ inputs.avatar_plan }}")) {
              throw "avatar_plan not found: ${{ inputs.avatar_plan }}"
            }
            if (-not (Test-Path "${{ inputs.avatar_project_path }}")) {
              throw "avatar_project_path not found: ${{ inputs.avatar_project_path }}"
            }
          }
          if ($target -eq "all" -or $target -eq "world") {
            if (-not (Test-Path "${{ inputs.world_plan }}")) {
              throw "world_plan not found: ${{ inputs.world_plan }}"
            }
            if (-not (Test-Path "${{ inputs.world_project_path }}")) {
              throw "world_project_path not found: ${{ inputs.world_project_path }}"
            }
          }
          if (($windowStartRaw -eq "") -xor ($windowEndRaw -eq "")) {
            throw "run_window_start_utc_hour and run_window_end_utc_hour must be provided together."
          }
          $timeoutProfilePath = "${{ inputs.timeout_profile_path }}"
          if ($timeoutProfilePath -ne "" -and -not (Test-Path $timeoutProfilePath)) {
            throw "timeout_profile_path not found: $timeoutProfilePath"
          }
          if ($windowStartRaw -ne "") {
            $parsedStart = 0
            $parsedEnd = 0
            if (-not [int]::TryParse($windowStartRaw, [ref]$parsedStart)) {
              throw "run_window_start_utc_hour must be an integer between 0 and 23."
            }
            if (-not [int]::TryParse($windowEndRaw, [ref]$parsedEnd)) {
              throw "run_window_end_utc_hour must be an integer between 0 and 23."
            }
            $windowStart = $parsedStart
            $windowEnd = $parsedEnd
            if ($windowStart -lt 0 -or $windowStart -gt 23) {
              throw "run_window_start_utc_hour must be in range 0..23."
            }
            if ($windowEnd -lt 0 -or $windowEnd -gt 23) {
              throw "run_window_end_utc_hour must be in range 0..23."
            }
          }

      - name: Evaluate UTC Run Window
        id: run_window
        shell: pwsh
        run: |
          $windowStartRaw = "${{ inputs.run_window_start_utc_hour }}"
          $windowEndRaw = "${{ inputs.run_window_end_utc_hour }}"
          if ($windowStartRaw -eq "" -and $windowEndRaw -eq "") {
            "within_window=true" >> $env:GITHUB_OUTPUT
            "window_reason=No run window configured." >> $env:GITHUB_OUTPUT
            exit 0
          }

          $windowStart = [int]$windowStartRaw
          $windowEnd = [int]$windowEndRaw
          $currentUtcHour = [DateTime]::UtcNow.Hour
          $withinWindow = $false
          if ($windowStart -eq $windowEnd) {
            $withinWindow = $true
          } elseif ($windowStart -lt $windowEnd) {
            $withinWindow = ($currentUtcHour -ge $windowStart -and $currentUtcHour -lt $windowEnd)
          } else {
            $withinWindow = ($currentUtcHour -ge $windowStart -or $currentUtcHour -lt $windowEnd)
          }

          "within_window=$($withinWindow.ToString().ToLowerInvariant())" >> $env:GITHUB_OUTPUT
          "window_reason=Current UTC hour: $currentUtcHour, configured window: [$windowStart, $windowEnd)." >> $env:GITHUB_OUTPUT

      - name: Run Bridge Smoke Batch (Unity-enabled)
        if: ${{ steps.run_window.outputs.within_window == 'true' }}
        shell: pwsh
        run: |
          $args = @(
            "validate",
            "smoke-batch",
            "--targets", "${{ inputs.targets }}",
            "--avatar-plan", "${{ inputs.avatar_plan }}",
            "--world-plan", "${{ inputs.world_plan }}",
            "--avatar-project-path", "${{ inputs.avatar_project_path }}",
            "--world-project-path", "${{ inputs.world_project_path }}",
            "--unity-command", "${{ inputs.unity_command }}",
            "--unity-execute-method", "${{ inputs.unity_execute_method }}",
            "--out-dir", "reports/bridge_smoke",
            "--summary-md", "reports/bridge_smoke/summary.md"
          )
          if ("${{ inputs.unity_timeout_sec }}" -ne "") {
            $args += @("--unity-timeout-sec", "${{ inputs.unity_timeout_sec }}")
          }
          if ("${{ inputs.avatar_unity_timeout_sec }}" -ne "") {
            $args += @("--avatar-unity-timeout-sec", "${{ inputs.avatar_unity_timeout_sec }}")
          }
          if ("${{ inputs.world_unity_timeout_sec }}" -ne "") {
            $args += @("--world-unity-timeout-sec", "${{ inputs.world_unity_timeout_sec }}")
          }
          if ("${{ inputs.timeout_profile_path }}" -ne "") {
            $args += @("--timeout-profile", "${{ inputs.timeout_profile_path }}")
          }
          if ("${{ inputs.expect_applied_from_plan }}" -eq "true") {
            $args += @("--expect-applied-from-plan")
          }
          prefab-sentinel @args

      - name: Build Unity Smoke Decision Table Artifacts
        if: ${{ steps.run_window.outputs.within_window == 'true' }}
        shell: pwsh
        run: |
          $args = @(
            "report",
            "smoke-history",
            "--inputs", "reports/bridge_smoke/summary.json",
            "--duration-percentile", "90",
            "--out", "reports/bridge_smoke/history.csv",
            "--out-md", "reports/bridge_smoke/history.md",
            "--out-timeout-profile", "reports/bridge_smoke/timeout_profile.json"
          )
          if ("${{ inputs.max_applied_mismatches }}" -ne "") {
            $args += @("--max-applied-mismatches", "${{ inputs.max_applied_mismatches }}")
          }
          if ("${{ inputs.min_applied_pass_pct }}" -ne "") {
            $args += @("--min-applied-pass-pct", "${{ inputs.min_applied_pass_pct }}")
          }
          prefab-sentinel @args

      - name: Skip Outside UTC Run Window
        if: ${{ steps.run_window.outputs.within_window != 'true' }}
        shell: pwsh
        run: |
          Write-Host "Skipping Unity smoke batch because run window condition was not met."
          Write-Host "${{ steps.run_window.outputs.window_reason }}"

      - name: Upload Unity Smoke Summary
        if: ${{ steps.run_window.outputs.within_window == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: unity-smoke-summary
          path: |
            reports/bridge_smoke/summary.json
            reports/bridge_smoke/summary.md
            reports/bridge_smoke/history.csv
            reports/bridge_smoke/history.md
            reports/bridge_smoke/timeout_profile.json
          if-no-files-found: error

      - name: Upload Unity Smoke Avatar Artifact
        if: ${{ steps.run_window.outputs.within_window == 'true' && (inputs.targets == 'all' || inputs.targets == 'avatar') }}
        uses: actions/upload-artifact@v4
        with:
          name: unity-smoke-avatar
          path: reports/bridge_smoke/avatar
          if-no-files-found: error

      - name: Upload Unity Smoke World Artifact
        if: ${{ steps.run_window.outputs.within_window == 'true' && (inputs.targets == 'all' || inputs.targets == 'world') }}
        uses: actions/upload-artifact@v4
        with:
          name: unity-smoke-world
          path: reports/bridge_smoke/world
          if-no-files-found: error
