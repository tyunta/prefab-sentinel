name: unity-smoke

on:
  workflow_dispatch:
    inputs:
      unity_command:
        description: "Path to Unity.exe used for batchmode."
        required: true
        type: string
      targets:
        description: "Smoke target selection."
        required: true
        default: all
        type: choice
        options:
          - all
          - avatar
          - world
      unity_execute_method:
        description: "Unity executeMethod entrypoint."
        required: false
        default: "PrefabSentinel.UnityPatchBridge.ApplyFromJson"
        type: string
      unity_timeout_sec:
        description: "Batchmode timeout (seconds)."
        required: false
        default: "600"
        type: string
      avatar_plan:
        description: "Avatar patch plan path."
        required: false
        default: "sample/avatar/config/prefab_patch_plan.json"
        type: string
      world_plan:
        description: "World patch plan path."
        required: false
        default: "sample/world/config/prefab_patch_plan.json"
        type: string
      avatar_project_path:
        description: "Avatar Unity project root."
        required: false
        default: "sample/avatar"
        type: string
      world_project_path:
        description: "World Unity project root."
        required: false
        default: "sample/world"
        type: string

jobs:
  bridge-smoke-unity:
    runs-on:
      - self-hosted
      - windows
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Package
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .

      - name: Preflight Input Paths
        shell: pwsh
        run: |
          $target = "${{ inputs.targets }}"
          if ($target -eq "all" -or $target -eq "avatar") {
            if (-not (Test-Path "${{ inputs.avatar_plan }}")) {
              throw "avatar_plan not found: ${{ inputs.avatar_plan }}"
            }
            if (-not (Test-Path "${{ inputs.avatar_project_path }}")) {
              throw "avatar_project_path not found: ${{ inputs.avatar_project_path }}"
            }
          }
          if ($target -eq "all" -or $target -eq "world") {
            if (-not (Test-Path "${{ inputs.world_plan }}")) {
              throw "world_plan not found: ${{ inputs.world_plan }}"
            }
            if (-not (Test-Path "${{ inputs.world_project_path }}")) {
              throw "world_project_path not found: ${{ inputs.world_project_path }}"
            }
          }

      - name: Run Bridge Smoke Batch (Unity-enabled)
        shell: pwsh
        run: |
          python scripts/bridge_smoke_samples.py --targets "${{ inputs.targets }}" --avatar-plan "${{ inputs.avatar_plan }}" --world-plan "${{ inputs.world_plan }}" --avatar-project-path "${{ inputs.avatar_project_path }}" --world-project-path "${{ inputs.world_project_path }}" --unity-command "${{ inputs.unity_command }}" --unity-execute-method "${{ inputs.unity_execute_method }}" --unity-timeout-sec "${{ inputs.unity_timeout_sec }}" --out-dir reports/bridge_smoke --summary-md reports/bridge_smoke/summary.md

      - name: Upload Unity Smoke Summary
        uses: actions/upload-artifact@v4
        with:
          name: unity-smoke-summary
          path: |
            reports/bridge_smoke/summary.json
            reports/bridge_smoke/summary.md
          if-no-files-found: error

      - name: Upload Unity Smoke Avatar Artifact
        if: ${{ inputs.targets == 'all' || inputs.targets == 'avatar' }}
        uses: actions/upload-artifact@v4
        with:
          name: unity-smoke-avatar
          path: reports/bridge_smoke/avatar
          if-no-files-found: error

      - name: Upload Unity Smoke World Artifact
        if: ${{ inputs.targets == 'all' || inputs.targets == 'world' }}
        uses: actions/upload-artifact@v4
        with:
          name: unity-smoke-world
          path: reports/bridge_smoke/world
          if-no-files-found: error
