# UnityTool Ideas And Roadmap

## Purpose
- Keep implementation ideas and execution order in one place.
- Distinguish between executable tasks and decision-required tasks.

## Current Status (Implemented)
- `validate refs` / `suggest ignore-guids` support:
  - `--ignore-guid`
  - `--ignore-guid-file`
- `suggest ignore-guids` supports:
  - `--out-ignore-guid-file`
  - `--out-ignore-guid-mode {replace|append}`
- Scope-aware GUID index for faster scans in multi-project repositories.
- `where_used` excludes heavy non-target directories by default.
- CLI `inspect where-used` with:
  - `--scope`
  - `--exclude`
  - `--max-usages`
- Markdown report includes noise-reduction summary metrics when ref-scan data exists.
- Added `scripts/benchmark_refs.py` for repeatable `validate refs` timing runs.
- `report export` supports markdown usage compaction:
  - `--md-max-usages`
  - `--md-omit-usages`
- `scripts/benchmark_refs.py` supports CSV output:
  - `--out-csv`
  - `--csv-append`
- `scripts/benchmark_refs.py` supports warm-up runs:
  - `--warmup-runs`
- Added `scripts/benchmark_history_to_csv.py` to combine JSON benchmarks into one CSV.
- `scripts/benchmark_refs.py` supports percentile output:
  - `p50`
  - `p90`
- `scripts/benchmark_refs.py` supports generated timestamp output:
  - `--include-generated-date`
  - `generated_at_utc`
- `scripts/benchmark_history_to_csv.py` supports filters:
  - `--scope-contains`
  - `--severity`
- `scripts/benchmark_history_to_csv.py` supports sorting:
  - `--sort-by {source|scope|avg_sec}`
  - `--sort-order {asc|desc}`
- `scripts/benchmark_history_to_csv.py` supports optional date column:
  - `--include-date-column`
  - `generated_date_utc`
- `scripts/benchmark_history_to_csv.py` supports generated date prefix filter:
  - `--generated-date-prefix`
- `scripts/benchmark_history_to_csv.py` supports slowest-row compaction:
  - `--top-slowest`
- `scripts/benchmark_history_to_csv.py` supports percentile threshold filter:
  - `--min-p90`
- `scripts/benchmark_history_to_csv.py` supports latest-row compaction:
  - `--latest-per-scope`
- `scripts/benchmark_history_to_csv.py` normalizes mixed scope path separators (`/` and `\`).
- `scripts/benchmark_history_to_csv.py` supports severity-split exports:
  - `--split-by-severity`
- `scripts/benchmark_history_to_csv.py` supports markdown snapshot output:
  - `--out-md`
- `scripts/benchmark_history_to_csv.py` ignores non-benchmark JSON schema rows.
- Added `scripts/benchmark_samples.py` for sample avatar/world benchmark orchestration.
- Added `scripts/benchmark_regression_report.py` for baseline/latest benchmark regression detection.
- `scripts/benchmark_samples.py` can run regression report in one flow:
  - `--run-regression`
  - `--regression-baseline-inputs`
- `scripts/benchmark_samples.py` supports baseline auto-discovery:
  - `--regression-baseline-auto-latest`
- `scripts/benchmark_regression_report.py` supports CI-oriented alerts:
  - `--alerts-only`
  - `--fail-on-regression`
- `scripts/benchmark_regression_report.py` supports CSV history append:
  - `--out-csv-append`
- `scripts/benchmark_regression_report.py` supports markdown summary export:
  - `--out-md`
- `scripts/benchmark_samples.py` can request regression markdown output:
  - `--regression-out-md`
- `scripts/benchmark_regression_report.py` supports per-scope baseline pinning:
  - `--baseline-pinning-file`
- `scripts/benchmark_samples.py` can forward baseline pinning file:
  - `--regression-baseline-pinning-file`
- Added runtime validation scaffold command:
  - `unitytool validate runtime --scene ...`
  - log-based classification (`BROKEN_PPTR`, `UDON_NULLREF`, etc.)
  - runtime assertion step (`assert_no_critical_errors`)
- Added patch apply scaffold command:
  - `unitytool patch hash --plan ...`
  - `unitytool patch sign --plan ...`
  - `unitytool patch attest --plan ...`
  - `unitytool patch verify --plan ...`
  - `unitytool patch apply --plan ... --dry-run`
  - optional attestation verification (`--attestation-file`)
  - optional plan digest verification (`--plan-sha256`)
  - optional plan signature verification (`--plan-signature`)
  - optional JSON report output (`--out-report`)
  - plan schema validation + dry-run diff preview
  - non-dry-run confirm gate (`--confirm`)
  - optional preflight reference scan (`--scope`)
  - optional prefab override preflight (`list_overrides` for `.prefab` target)
  - optional post-apply runtime validation sequence (`--runtime-scene` and related flags)
  - JSON target apply backend (`SER_APPLY_OK`, `.json` only)
  - Unity bridge adapter via `UNITYTOOL_PATCH_BRIDGE` (allowlisted external command)
  - bridge protocol version check (`protocol_version: 1`)
- Added Unity bridge script with batchmode command execution path:
  - `tools/unity_patch_bridge.py` (`UNITYTOOL_UNITY_COMMAND` / request-response file contract)
  - strict Unity response envelope validation (`BRIDGE_UNITY_RESPONSE_SCHEMA` on missing/invalid `success|severity|code|message|data|diagnostics`)
- Added Unity bridge smoke runner for end-to-end bridge invocation from patch plans:
  - `scripts/unity_bridge_smoke.py`
  - `--plan` required + bridge request shaping (`protocol_version` / `target` / `ops`)
  - Unity execution env overrides (`--unity-command` / `--unity-project-path` / `--unity-execute-method` / `--unity-timeout-sec` / `--unity-log-file`)
  - expectation checks (`--expect-failure`) and optional response export (`--out`)
  - bridge response envelope validation (`success` / `severity` / `code` / `message` / `data` / `diagnostics`) with fail-fast errors
- Added smoke runner unit tests:
  - `tests/test_unity_bridge_smoke.py`
- Unity bridge now normalizes op values for executeMethod payload (`value_kind` fields).
- Added Unity Editor executeMethod apply path for prefab patch operations:
  - `tools/unity/PrefabSentinel.UnityPatchBridge.cs` (`PrefabSentinel.UnityPatchBridge.ApplyFromJson`)
  - supports `.prefab` + `set` / `insert_array_element` / `remove_array_element`
  - `set` value decoding covers primitive/null + `enum`/`Color`/`Vector2/3/4`/`Vector2Int/3Int`/`Rect/RectInt`/`Bounds/BoundsInt`/`Quaternion`/`ObjectReference({guid,file_id})`
  - component ambiguity and array-path mistakes return richer fail-fast diagnostics
  - component selector accepts `TypeName@Hierarchy/Path` for explicit disambiguation
- `report export --format md` supports runtime summary section for `VALIDATE_RUNTIME_RESULT`.
- `report export --format md` supports `--md-max-steps` / `--md-omit-steps` to trim large `data.steps`.

## Next Executable Tasks
- Extend Unity executeMethod apply coverage:
  - broader SerializedProperty support (nested managed-reference scenarios, complex custom structs)
  - Unity-side integration tests against sample prefab assets (batchmode assertions)
- Add CI/automation entry for `scripts/unity_bridge_smoke.py`:
  - run smoke against sample avatar/world plans with deterministic artifact output (`--out` JSON + Unity log path)

## Decision-Required Queue
- Decide default location/policy for ignore-guid files:
  - Option A: project local (`config/ignore_guids.txt`)
  - Option B: scope local (`<scope>/config/ignore_guids.txt`)
  - Option C: user managed only (no default path)
- Decide whether to allow automatic ignore-guid application in CI.

## Notes
- Keep read-only policy for inspection/validation commands in Phase 1.
- `patch apply` is write-enabled only for explicit `--confirm`.
- JSON targets use built-in backend; Unity targets require external bridge command (`UNITYTOOL_PATCH_BRIDGE`).
- Continue fail-fast for invalid input and missing required paths.
