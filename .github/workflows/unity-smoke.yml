name: unity-smoke

on:
  workflow_dispatch:
    inputs:
      unity_command:
        description: "Path to Unity.exe used for batchmode."
        required: true
        type: string
      targets:
        description: "Smoke target selection."
        required: true
        default: all
        type: choice
        options:
          - all
          - avatar
          - world
      unity_execute_method:
        description: "Unity executeMethod entrypoint."
        required: false
        default: "PrefabSentinel.UnityPatchBridge.ApplyFromJson"
        type: string
      unity_timeout_sec:
        description: "Batchmode timeout (seconds)."
        required: false
        default: "600"
        type: string
      avatar_unity_timeout_sec:
        description: "Avatar target-specific timeout (seconds). Optional."
        required: false
        default: ""
        type: string
      world_unity_timeout_sec:
        description: "World target-specific timeout (seconds). Optional."
        required: false
        default: ""
        type: string
      timeout_profile_path:
        description: "Optional timeout profile JSON path (smoke-history output)."
        required: false
        default: ""
        type: string
      history_duration_percentile:
        description: "smoke-history duration percentile for timeout profile generation."
        required: false
        default: "90"
        type: string
      history_timeout_multiplier:
        description: "smoke-history timeout multiplier policy parameter."
        required: false
        default: "1.5"
        type: string
      history_timeout_slack_sec:
        description: "smoke-history timeout slack seconds policy parameter."
        required: false
        default: "60"
        type: string
      history_timeout_min_sec:
        description: "smoke-history timeout minimum seconds policy parameter."
        required: false
        default: "300"
        type: string
      history_timeout_round_sec:
        description: "smoke-history timeout rounding seconds policy parameter."
        required: false
        default: "30"
        type: string
      expect_applied_from_plan:
        description: "Infer expected applied count from each target plan ops length."
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"
      avatar_expected_code:
        description: "Optional expected response code assertion for avatar target."
        required: false
        default: ""
        type: string
      world_expected_code:
        description: "Optional expected response code assertion for world target."
        required: false
        default: ""
        type: string
      max_code_mismatches:
        description: "Optional smoke-history gate: maximum allowed code assertion mismatches."
        required: false
        default: ""
        type: string
      min_code_pass_pct:
        description: "Optional smoke-history gate: minimum required code assertion pass percentage."
        required: false
        default: ""
        type: string
      max_applied_mismatches:
        description: "Optional smoke-history gate: maximum allowed applied assertion mismatches."
        required: false
        default: "0"
        type: string
      min_applied_pass_pct:
        description: "Optional smoke-history gate: minimum required applied assertion pass percentage."
        required: false
        default: "100"
        type: string
      max_observed_timeout_breaches:
        description: "Optional smoke-history gate: maximum allowed observed duration>timeout breaches."
        required: false
        default: "0"
        type: string
      min_observed_timeout_coverage_pct:
        description: "Optional smoke-history gate: minimum required observed timeout coverage percentage."
        required: false
        default: "100"
        type: string
      max_observed_timeout_breaches_per_target:
        description: "Optional smoke-history gate: maximum allowed observed duration>timeout breaches for any target."
        required: false
        default: "0"
        type: string
      min_observed_timeout_coverage_pct_per_target:
        description: "Optional smoke-history gate: minimum required observed timeout coverage percentage for each target."
        required: false
        default: "100"
        type: string
      max_profile_timeout_breaches:
        description: "Optional smoke-history gate: maximum allowed timeout-profile breaches for selected policy."
        required: false
        default: "0"
        type: string
      min_profile_timeout_coverage_pct:
        description: "Optional smoke-history gate: minimum required timeout-profile coverage percentage for selected policy."
        required: false
        default: "100"
        type: string
      max_profile_timeout_breaches_per_target:
        description: "Optional smoke-history gate: maximum allowed timeout-profile breaches for any target under selected policy."
        required: false
        default: "0"
        type: string
      min_profile_timeout_coverage_pct_per_target:
        description: "Optional smoke-history gate: minimum required timeout-profile coverage percentage for each target under selected policy."
        required: false
        default: "100"
        type: string
      avatar_plan:
        description: "Avatar patch plan path."
        required: false
        default: "sample/avatar/config/prefab_patch_plan.json"
        type: string
      world_plan:
        description: "World patch plan path."
        required: false
        default: "sample/world/config/prefab_patch_plan.json"
        type: string
      avatar_project_path:
        description: "Avatar Unity project root."
        required: false
        default: "sample/avatar"
        type: string
      world_project_path:
        description: "World Unity project root."
        required: false
        default: "sample/world"
        type: string
      run_window_start_utc_hour:
        description: "Optional UTC run window start hour (0-23)."
        required: false
        default: ""
        type: string
      run_window_end_utc_hour:
        description: "Optional UTC run window end hour (0-23)."
        required: false
        default: ""
        type: string

jobs:
  bridge-smoke-unity:
    runs-on:
      - self-hosted
      - windows
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Package
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .

      - name: Preflight Input Paths
        shell: pwsh
        run: |
          $target = "${{ inputs.targets }}"
          $windowStartRaw = "${{ inputs.run_window_start_utc_hour }}"
          $windowEndRaw = "${{ inputs.run_window_end_utc_hour }}"
          $historyDurationPercentileRaw = "${{ inputs.history_duration_percentile }}"
          $historyTimeoutMultiplierRaw = "${{ inputs.history_timeout_multiplier }}"
          $historyTimeoutSlackSecRaw = "${{ inputs.history_timeout_slack_sec }}"
          $historyTimeoutMinSecRaw = "${{ inputs.history_timeout_min_sec }}"
          $historyTimeoutRoundSecRaw = "${{ inputs.history_timeout_round_sec }}"
          $maxCodeMismatchesRaw = "${{ inputs.max_code_mismatches }}"
          $minCodePassPctRaw = "${{ inputs.min_code_pass_pct }}"
          $maxAppliedMismatchesRaw = "${{ inputs.max_applied_mismatches }}"
          $minAppliedPassPctRaw = "${{ inputs.min_applied_pass_pct }}"
          $maxObservedTimeoutBreachesRaw = "${{ inputs.max_observed_timeout_breaches }}"
          $minObservedTimeoutCoveragePctRaw = "${{ inputs.min_observed_timeout_coverage_pct }}"
          $maxObservedTimeoutBreachesPerTargetRaw = "${{ inputs.max_observed_timeout_breaches_per_target }}"
          $minObservedTimeoutCoveragePctPerTargetRaw = "${{ inputs.min_observed_timeout_coverage_pct_per_target }}"
          $maxProfileTimeoutBreachesRaw = "${{ inputs.max_profile_timeout_breaches }}"
          $minProfileTimeoutCoveragePctRaw = "${{ inputs.min_profile_timeout_coverage_pct }}"
          $maxProfileTimeoutBreachesPerTargetRaw = "${{ inputs.max_profile_timeout_breaches_per_target }}"
          $minProfileTimeoutCoveragePctPerTargetRaw = "${{ inputs.min_profile_timeout_coverage_pct_per_target }}"
          if ($target -eq "all" -or $target -eq "avatar") {
            if (-not (Test-Path "${{ inputs.avatar_plan }}")) {
              throw "avatar_plan not found: ${{ inputs.avatar_plan }}"
            }
            if (-not (Test-Path "${{ inputs.avatar_project_path }}")) {
              throw "avatar_project_path not found: ${{ inputs.avatar_project_path }}"
            }
          }
          if ($target -eq "all" -or $target -eq "world") {
            if (-not (Test-Path "${{ inputs.world_plan }}")) {
              throw "world_plan not found: ${{ inputs.world_plan }}"
            }
            if (-not (Test-Path "${{ inputs.world_project_path }}")) {
              throw "world_project_path not found: ${{ inputs.world_project_path }}"
            }
          }
          if (($windowStartRaw -eq "") -xor ($windowEndRaw -eq "")) {
            throw "run_window_start_utc_hour and run_window_end_utc_hour must be provided together."
          }
          $timeoutProfilePath = "${{ inputs.timeout_profile_path }}"
          if ($timeoutProfilePath -ne "" -and -not (Test-Path $timeoutProfilePath)) {
            throw "timeout_profile_path not found: $timeoutProfilePath"
          }
          if ($windowStartRaw -ne "") {
            $parsedStart = 0
            $parsedEnd = 0
            if (-not [int]::TryParse($windowStartRaw, [ref]$parsedStart)) {
              throw "run_window_start_utc_hour must be an integer between 0 and 23."
            }
            if (-not [int]::TryParse($windowEndRaw, [ref]$parsedEnd)) {
              throw "run_window_end_utc_hour must be an integer between 0 and 23."
            }
            $windowStart = $parsedStart
            $windowEnd = $parsedEnd
            if ($windowStart -lt 0 -or $windowStart -gt 23) {
              throw "run_window_start_utc_hour must be in range 0..23."
            }
            if ($windowEnd -lt 0 -or $windowEnd -gt 23) {
              throw "run_window_end_utc_hour must be in range 0..23."
            }
          }
          $historyDurationPercentile = 0.0
          if (-not [double]::TryParse($historyDurationPercentileRaw, [System.Globalization.NumberStyles]::Float, [System.Globalization.CultureInfo]::InvariantCulture, [ref]$historyDurationPercentile)) {
            throw "history_duration_percentile must be a number in range 0..100."
          }
          if ($historyDurationPercentile -lt 0.0 -or $historyDurationPercentile -gt 100.0) {
            throw "history_duration_percentile must be in range 0..100."
          }
          $historyTimeoutMultiplier = 0.0
          if (-not [double]::TryParse($historyTimeoutMultiplierRaw, [System.Globalization.NumberStyles]::Float, [System.Globalization.CultureInfo]::InvariantCulture, [ref]$historyTimeoutMultiplier)) {
            throw "history_timeout_multiplier must be a number greater than or equal to 1.0."
          }
          if ($historyTimeoutMultiplier -lt 1.0) {
            throw "history_timeout_multiplier must be greater than or equal to 1.0."
          }
          $historyTimeoutSlackSec = 0
          if (-not [int]::TryParse($historyTimeoutSlackSecRaw, [ref]$historyTimeoutSlackSec)) {
            throw "history_timeout_slack_sec must be an integer greater than or equal to 0."
          }
          if ($historyTimeoutSlackSec -lt 0) {
            throw "history_timeout_slack_sec must be greater than or equal to 0."
          }
          $historyTimeoutMinSec = 0
          if (-not [int]::TryParse($historyTimeoutMinSecRaw, [ref]$historyTimeoutMinSec)) {
            throw "history_timeout_min_sec must be an integer greater than 0."
          }
          if ($historyTimeoutMinSec -le 0) {
            throw "history_timeout_min_sec must be greater than 0."
          }
          $historyTimeoutRoundSec = 0
          if (-not [int]::TryParse($historyTimeoutRoundSecRaw, [ref]$historyTimeoutRoundSec)) {
            throw "history_timeout_round_sec must be an integer greater than 0."
          }
          if ($historyTimeoutRoundSec -le 0) {
            throw "history_timeout_round_sec must be greater than 0."
          }
          if ($maxCodeMismatchesRaw -ne "") {
            $maxCodeMismatches = 0
            if (-not [int]::TryParse($maxCodeMismatchesRaw, [ref]$maxCodeMismatches)) {
              throw "max_code_mismatches must be an integer greater than or equal to 0."
            }
            if ($maxCodeMismatches -lt 0) {
              throw "max_code_mismatches must be greater than or equal to 0."
            }
          }
          if ($minCodePassPctRaw -ne "") {
            $minCodePassPct = 0.0
            if (-not [double]::TryParse($minCodePassPctRaw, [System.Globalization.NumberStyles]::Float, [System.Globalization.CultureInfo]::InvariantCulture, [ref]$minCodePassPct)) {
              throw "min_code_pass_pct must be a number in range 0..100."
            }
            if ($minCodePassPct -lt 0.0 -or $minCodePassPct -gt 100.0) {
              throw "min_code_pass_pct must be in range 0..100."
            }
          }
          if ($maxAppliedMismatchesRaw -ne "") {
            $maxAppliedMismatches = 0
            if (-not [int]::TryParse($maxAppliedMismatchesRaw, [ref]$maxAppliedMismatches)) {
              throw "max_applied_mismatches must be an integer greater than or equal to 0."
            }
            if ($maxAppliedMismatches -lt 0) {
              throw "max_applied_mismatches must be greater than or equal to 0."
            }
          }
          if ($minAppliedPassPctRaw -ne "") {
            $minAppliedPassPct = 0.0
            if (-not [double]::TryParse($minAppliedPassPctRaw, [System.Globalization.NumberStyles]::Float, [System.Globalization.CultureInfo]::InvariantCulture, [ref]$minAppliedPassPct)) {
              throw "min_applied_pass_pct must be a number in range 0..100."
            }
            if ($minAppliedPassPct -lt 0.0 -or $minAppliedPassPct -gt 100.0) {
              throw "min_applied_pass_pct must be in range 0..100."
            }
          }
          if ($maxObservedTimeoutBreachesRaw -ne "") {
            $maxObservedTimeoutBreaches = 0
            if (-not [int]::TryParse($maxObservedTimeoutBreachesRaw, [ref]$maxObservedTimeoutBreaches)) {
              throw "max_observed_timeout_breaches must be an integer greater than or equal to 0."
            }
            if ($maxObservedTimeoutBreaches -lt 0) {
              throw "max_observed_timeout_breaches must be greater than or equal to 0."
            }
          }
          if ($minObservedTimeoutCoveragePctRaw -ne "") {
            $minObservedTimeoutCoveragePct = 0.0
            if (-not [double]::TryParse($minObservedTimeoutCoveragePctRaw, [System.Globalization.NumberStyles]::Float, [System.Globalization.CultureInfo]::InvariantCulture, [ref]$minObservedTimeoutCoveragePct)) {
              throw "min_observed_timeout_coverage_pct must be a number in range 0..100."
            }
            if ($minObservedTimeoutCoveragePct -lt 0.0 -or $minObservedTimeoutCoveragePct -gt 100.0) {
              throw "min_observed_timeout_coverage_pct must be in range 0..100."
            }
          }
          if ($maxObservedTimeoutBreachesPerTargetRaw -ne "") {
            $maxObservedTimeoutBreachesPerTarget = 0
            if (-not [int]::TryParse($maxObservedTimeoutBreachesPerTargetRaw, [ref]$maxObservedTimeoutBreachesPerTarget)) {
              throw "max_observed_timeout_breaches_per_target must be an integer greater than or equal to 0."
            }
            if ($maxObservedTimeoutBreachesPerTarget -lt 0) {
              throw "max_observed_timeout_breaches_per_target must be greater than or equal to 0."
            }
          }
          if ($minObservedTimeoutCoveragePctPerTargetRaw -ne "") {
            $minObservedTimeoutCoveragePctPerTarget = 0.0
            if (-not [double]::TryParse($minObservedTimeoutCoveragePctPerTargetRaw, [System.Globalization.NumberStyles]::Float, [System.Globalization.CultureInfo]::InvariantCulture, [ref]$minObservedTimeoutCoveragePctPerTarget)) {
              throw "min_observed_timeout_coverage_pct_per_target must be a number in range 0..100."
            }
            if ($minObservedTimeoutCoveragePctPerTarget -lt 0.0 -or $minObservedTimeoutCoveragePctPerTarget -gt 100.0) {
              throw "min_observed_timeout_coverage_pct_per_target must be in range 0..100."
            }
          }
          if ($maxProfileTimeoutBreachesRaw -ne "") {
            $maxProfileTimeoutBreaches = 0
            if (-not [int]::TryParse($maxProfileTimeoutBreachesRaw, [ref]$maxProfileTimeoutBreaches)) {
              throw "max_profile_timeout_breaches must be an integer greater than or equal to 0."
            }
            if ($maxProfileTimeoutBreaches -lt 0) {
              throw "max_profile_timeout_breaches must be greater than or equal to 0."
            }
          }
          if ($minProfileTimeoutCoveragePctRaw -ne "") {
            $minProfileTimeoutCoveragePct = 0.0
            if (-not [double]::TryParse($minProfileTimeoutCoveragePctRaw, [System.Globalization.NumberStyles]::Float, [System.Globalization.CultureInfo]::InvariantCulture, [ref]$minProfileTimeoutCoveragePct)) {
              throw "min_profile_timeout_coverage_pct must be a number in range 0..100."
            }
            if ($minProfileTimeoutCoveragePct -lt 0.0 -or $minProfileTimeoutCoveragePct -gt 100.0) {
              throw "min_profile_timeout_coverage_pct must be in range 0..100."
            }
          }
          if ($maxProfileTimeoutBreachesPerTargetRaw -ne "") {
            $maxProfileTimeoutBreachesPerTarget = 0
            if (-not [int]::TryParse($maxProfileTimeoutBreachesPerTargetRaw, [ref]$maxProfileTimeoutBreachesPerTarget)) {
              throw "max_profile_timeout_breaches_per_target must be an integer greater than or equal to 0."
            }
            if ($maxProfileTimeoutBreachesPerTarget -lt 0) {
              throw "max_profile_timeout_breaches_per_target must be greater than or equal to 0."
            }
          }
          if ($minProfileTimeoutCoveragePctPerTargetRaw -ne "") {
            $minProfileTimeoutCoveragePctPerTarget = 0.0
            if (-not [double]::TryParse($minProfileTimeoutCoveragePctPerTargetRaw, [System.Globalization.NumberStyles]::Float, [System.Globalization.CultureInfo]::InvariantCulture, [ref]$minProfileTimeoutCoveragePctPerTarget)) {
              throw "min_profile_timeout_coverage_pct_per_target must be a number in range 0..100."
            }
            if ($minProfileTimeoutCoveragePctPerTarget -lt 0.0 -or $minProfileTimeoutCoveragePctPerTarget -gt 100.0) {
              throw "min_profile_timeout_coverage_pct_per_target must be in range 0..100."
            }
          }

      - name: Evaluate UTC Run Window
        id: run_window
        shell: pwsh
        run: |
          $windowStartRaw = "${{ inputs.run_window_start_utc_hour }}"
          $windowEndRaw = "${{ inputs.run_window_end_utc_hour }}"
          if ($windowStartRaw -eq "" -and $windowEndRaw -eq "") {
            "within_window=true" >> $env:GITHUB_OUTPUT
            "window_reason=No run window configured." >> $env:GITHUB_OUTPUT
            exit 0
          }

          $windowStart = [int]$windowStartRaw
          $windowEnd = [int]$windowEndRaw
          $currentUtcHour = [DateTime]::UtcNow.Hour
          $withinWindow = $false
          if ($windowStart -eq $windowEnd) {
            $withinWindow = $true
          } elseif ($windowStart -lt $windowEnd) {
            $withinWindow = ($currentUtcHour -ge $windowStart -and $currentUtcHour -lt $windowEnd)
          } else {
            $withinWindow = ($currentUtcHour -ge $windowStart -or $currentUtcHour -lt $windowEnd)
          }

          "within_window=$($withinWindow.ToString().ToLowerInvariant())" >> $env:GITHUB_OUTPUT
          "window_reason=Current UTC hour: $currentUtcHour, configured window: [$windowStart, $windowEnd)." >> $env:GITHUB_OUTPUT

      - name: Run Bridge Smoke Batch (Unity-enabled)
        if: ${{ steps.run_window.outputs.within_window == 'true' }}
        shell: pwsh
        run: |
          $args = @(
            "validate",
            "smoke-batch",
            "--targets", "${{ inputs.targets }}",
            "--avatar-plan", "${{ inputs.avatar_plan }}",
            "--world-plan", "${{ inputs.world_plan }}",
            "--avatar-project-path", "${{ inputs.avatar_project_path }}",
            "--world-project-path", "${{ inputs.world_project_path }}",
            "--unity-command", "${{ inputs.unity_command }}",
            "--unity-execute-method", "${{ inputs.unity_execute_method }}",
            "--out-dir", "reports/bridge_smoke",
            "--summary-md", "reports/bridge_smoke/summary.md"
          )
          if ("${{ inputs.unity_timeout_sec }}" -ne "") {
            $args += @("--unity-timeout-sec", "${{ inputs.unity_timeout_sec }}")
          }
          if ("${{ inputs.avatar_unity_timeout_sec }}" -ne "") {
            $args += @("--avatar-unity-timeout-sec", "${{ inputs.avatar_unity_timeout_sec }}")
          }
          if ("${{ inputs.world_unity_timeout_sec }}" -ne "") {
            $args += @("--world-unity-timeout-sec", "${{ inputs.world_unity_timeout_sec }}")
          }
          if ("${{ inputs.timeout_profile_path }}" -ne "") {
            $args += @("--timeout-profile", "${{ inputs.timeout_profile_path }}")
          }
          if ("${{ inputs.expect_applied_from_plan }}" -eq "true") {
            $args += @("--expect-applied-from-plan")
          }
          if ("${{ inputs.avatar_expected_code }}" -ne "") {
            $args += @("--avatar-expected-code", "${{ inputs.avatar_expected_code }}")
          }
          if ("${{ inputs.world_expected_code }}" -ne "") {
            $args += @("--world-expected-code", "${{ inputs.world_expected_code }}")
          }
          prefab-sentinel @args

      - name: Build Unity Smoke Decision Table Artifacts
        if: ${{ steps.run_window.outputs.within_window == 'true' }}
        shell: pwsh
        run: |
          $args = @(
            "report",
            "smoke-history",
            "--inputs", "reports/bridge_smoke/summary.json",
            "--duration-percentile", "${{ inputs.history_duration_percentile }}",
            "--out", "reports/bridge_smoke/history.csv",
            "--out-md", "reports/bridge_smoke/history.md",
            "--out-timeout-profile", "reports/bridge_smoke/timeout_profile.json",
            "--timeout-multiplier", "${{ inputs.history_timeout_multiplier }}",
            "--timeout-slack-sec", "${{ inputs.history_timeout_slack_sec }}",
            "--timeout-min-sec", "${{ inputs.history_timeout_min_sec }}",
            "--timeout-round-sec", "${{ inputs.history_timeout_round_sec }}"
          )
          if ("${{ inputs.max_applied_mismatches }}" -ne "") {
            $args += @("--max-applied-mismatches", "${{ inputs.max_applied_mismatches }}")
          }
          if ("${{ inputs.max_code_mismatches }}" -ne "") {
            $args += @("--max-code-mismatches", "${{ inputs.max_code_mismatches }}")
          }
          if ("${{ inputs.min_applied_pass_pct }}" -ne "") {
            $args += @("--min-applied-pass-pct", "${{ inputs.min_applied_pass_pct }}")
          }
          if ("${{ inputs.min_code_pass_pct }}" -ne "") {
            $args += @("--min-code-pass-pct", "${{ inputs.min_code_pass_pct }}")
          }
          if ("${{ inputs.max_observed_timeout_breaches }}" -ne "") {
            $args += @("--max-observed-timeout-breaches", "${{ inputs.max_observed_timeout_breaches }}")
          }
          if ("${{ inputs.min_observed_timeout_coverage_pct }}" -ne "") {
            $args += @("--min-observed-timeout-coverage-pct", "${{ inputs.min_observed_timeout_coverage_pct }}")
          }
          if ("${{ inputs.max_observed_timeout_breaches_per_target }}" -ne "") {
            $args += @("--max-observed-timeout-breaches-per-target", "${{ inputs.max_observed_timeout_breaches_per_target }}")
          }
          if ("${{ inputs.min_observed_timeout_coverage_pct_per_target }}" -ne "") {
            $args += @("--min-observed-timeout-coverage-pct-per-target", "${{ inputs.min_observed_timeout_coverage_pct_per_target }}")
          }
          if ("${{ inputs.max_profile_timeout_breaches }}" -ne "") {
            $args += @("--max-profile-timeout-breaches", "${{ inputs.max_profile_timeout_breaches }}")
          }
          if ("${{ inputs.min_profile_timeout_coverage_pct }}" -ne "") {
            $args += @("--min-profile-timeout-coverage-pct", "${{ inputs.min_profile_timeout_coverage_pct }}")
          }
          if ("${{ inputs.max_profile_timeout_breaches_per_target }}" -ne "") {
            $args += @("--max-profile-timeout-breaches-per-target", "${{ inputs.max_profile_timeout_breaches_per_target }}")
          }
          if ("${{ inputs.min_profile_timeout_coverage_pct_per_target }}" -ne "") {
            $args += @("--min-profile-timeout-coverage-pct-per-target", "${{ inputs.min_profile_timeout_coverage_pct_per_target }}")
          }
          prefab-sentinel @args

      - name: Skip Outside UTC Run Window
        if: ${{ steps.run_window.outputs.within_window != 'true' }}
        shell: pwsh
        run: |
          Write-Host "Skipping Unity smoke batch because run window condition was not met."
          Write-Host "${{ steps.run_window.outputs.window_reason }}"

      - name: Upload Unity Smoke Summary
        if: ${{ steps.run_window.outputs.within_window == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: unity-smoke-summary
          path: |
            reports/bridge_smoke/summary.json
            reports/bridge_smoke/summary.md
            reports/bridge_smoke/history.csv
            reports/bridge_smoke/history.md
            reports/bridge_smoke/timeout_profile.json
          if-no-files-found: error

      - name: Upload Unity Smoke Avatar Artifact
        if: ${{ steps.run_window.outputs.within_window == 'true' && (inputs.targets == 'all' || inputs.targets == 'avatar') }}
        uses: actions/upload-artifact@v4
        with:
          name: unity-smoke-avatar
          path: reports/bridge_smoke/avatar
          if-no-files-found: error

      - name: Upload Unity Smoke World Artifact
        if: ${{ steps.run_window.outputs.within_window == 'true' && (inputs.targets == 'all' || inputs.targets == 'world') }}
        uses: actions/upload-artifact@v4
        with:
          name: unity-smoke-world
          path: reports/bridge_smoke/world
          if-no-files-found: error
