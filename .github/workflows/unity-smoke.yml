name: unity-smoke

on:
  workflow_dispatch:
    inputs:
      unity_command:
        description: "Path to Unity.exe used for batchmode."
        required: true
        type: string
      unity_execute_method:
        description: "Unity executeMethod entrypoint."
        required: false
        default: "PrefabSentinel.UnityPatchBridge.ApplyFromJson"
        type: string
      unity_timeout_sec:
        description: "Batchmode timeout (seconds)."
        required: false
        default: "600"
        type: string
      avatar_plan:
        description: "Avatar patch plan path."
        required: false
        default: "sample/avatar/config/prefab_patch_plan.json"
        type: string
      world_plan:
        description: "World patch plan path."
        required: false
        default: "sample/world/config/prefab_patch_plan.json"
        type: string
      avatar_project_path:
        description: "Avatar Unity project root."
        required: false
        default: "sample/avatar"
        type: string
      world_project_path:
        description: "World Unity project root."
        required: false
        default: "sample/world"
        type: string

jobs:
  bridge-smoke-unity:
    runs-on:
      - self-hosted
      - windows
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Package
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .

      - name: Run Bridge Smoke Batch (Unity-enabled)
        shell: pwsh
        run: |
          python scripts/bridge_smoke_samples.py --targets all --avatar-plan "${{ inputs.avatar_plan }}" --world-plan "${{ inputs.world_plan }}" --avatar-project-path "${{ inputs.avatar_project_path }}" --world-project-path "${{ inputs.world_project_path }}" --unity-command "${{ inputs.unity_command }}" --unity-execute-method "${{ inputs.unity_execute_method }}" --unity-timeout-sec "${{ inputs.unity_timeout_sec }}" --out-dir reports/bridge_smoke --summary-md reports/bridge_smoke/summary.md

      - name: Upload Unity Smoke Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: unity-smoke-reports
          path: reports/bridge_smoke
